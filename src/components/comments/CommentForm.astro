---
import { PRESET_NAMES } from '../../types/comment';

interface Props {
    postSlug: string;
}

const { postSlug } = Astro.props;
---

<form id="comment-form" class="mt-8 p-6 rounded-lg border border-neutral-200 dark:border-neutral-800" data-post-slug={postSlug}>
    <h3 class="text-lg font-bold mb-4 text-stone-900 dark:text-zinc-50">
        leave a comment
    </h3>

    <!-- Name Selection -->
    <div class="mb-4">
        <label class="block text-sm font-medium mb-2 text-neutral-700 dark:text-neutral-300">
            choose your name
        </label>

        <!-- Preset Names -->
        <div class="flex flex-wrap gap-2 mb-3" id="preset-names">
            {PRESET_NAMES.map((name, index) => (
                <button
                    type="button"
                    class="preset-name px-3 py-1 text-sm rounded-md border border-neutral-200 dark:border-neutral-800 hover:border-neutral-400 dark:hover:border-neutral-600 transition-colors text-neutral-700 dark:text-neutral-300"
                    data-name={name}
                    data-selected={index === 0 ? "true" : undefined}
                >
                    {name}
                </button>
            ))}
        </div>

        <!-- Custom Name Toggle -->
        <button
            type="button"
            id="toggle-custom"
            class="text-sm text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300 transition-colors"
        >
            or use a custom name
        </button>

        <!-- Custom Name Input (hidden by default) -->
        <div id="custom-name-container" class="hidden mt-3">
            <input
                type="text"
                id="custom-name"
                maxlength="30"
                placeholder="enter your name..."
                class="w-full px-4 py-2 rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 text-stone-900 dark:text-zinc-50 focus:border-neutral-400 dark:focus:border-neutral-600 focus:outline-none placeholder:text-neutral-400 dark:placeholder:text-neutral-600"
            />
            <button
                type="button"
                id="back-to-preset"
                class="mt-2 text-sm text-neutral-500 hover:text-neutral-700 dark:hover:text-neutral-300 transition-colors"
            >
                back to preset names
            </button>
        </div>
    </div>

    <!-- Hidden fields to track selection -->
    <input type="hidden" id="selected-name" name="author" value={PRESET_NAMES[0]} />
    <input type="hidden" id="is-preset" name="isPresetName" value="true" />

    <!-- Comment Textarea -->
    <div class="mb-4">
        <label for="comment-content" class="block text-sm font-medium mb-2 text-neutral-700 dark:text-neutral-300">
            your thoughts
        </label>
        <textarea
            id="comment-content"
            name="content"
            rows="4"
            maxlength="1000"
            required
            placeholder="share your thoughts..."
            class="w-full px-4 py-3 rounded-lg border border-neutral-200 dark:border-neutral-800 bg-white dark:bg-neutral-900 text-stone-900 dark:text-zinc-50 focus:border-neutral-400 dark:focus:border-neutral-600 focus:outline-none placeholder:text-neutral-400 dark:placeholder:text-neutral-600 resize-none"
        ></textarea>
        <div class="text-right text-sm text-neutral-500 mt-1">
            <span id="char-count">0</span>/1000
        </div>
    </div>

    <!-- Submit Button -->
    <button
        type="submit"
        id="submit-btn"
        class="px-6 py-2 rounded-md border border-neutral-200 dark:border-neutral-800 bg-stone-900 dark:bg-zinc-50 text-zinc-50 dark:text-stone-900 hover:bg-stone-800 dark:hover:bg-zinc-200 font-bold transition-colors disabled:opacity-50 disabled:cursor-not-allowed"
    >
        submit
    </button>

    <!-- Status Messages -->
    <div id="form-status" class="mt-4 hidden">
        <p id="status-message" class="text-sm"></p>
    </div>
</form>

<script>
    const form = document.getElementById('comment-form') as HTMLFormElement;
    const presetButtons = document.querySelectorAll('.preset-name');
    const toggleCustom = document.getElementById('toggle-custom');
    const customContainer = document.getElementById('custom-name-container');
    const customInput = document.getElementById('custom-name') as HTMLInputElement;
    const backToPreset = document.getElementById('back-to-preset');
    const presetNamesContainer = document.getElementById('preset-names');
    const selectedNameInput = document.getElementById('selected-name') as HTMLInputElement;
    const isPresetInput = document.getElementById('is-preset') as HTMLInputElement;
    const textarea = document.getElementById('comment-content') as HTMLTextAreaElement;
    const charCount = document.getElementById('char-count');
    const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
    const formStatus = document.getElementById('form-status');
    const statusMessage = document.getElementById('status-message');

    // Handle preset name selection
    presetButtons.forEach(btn => {
        btn.addEventListener('click', () => {
            presetButtons.forEach(b => {
                b.removeAttribute('data-selected');
                b.classList.remove('bg-neutral-200', 'dark:bg-neutral-800');
            });
            btn.setAttribute('data-selected', 'true');
            btn.classList.add('bg-neutral-200', 'dark:bg-neutral-800');
            selectedNameInput.value = (btn as HTMLElement).dataset.name || '';
            isPresetInput.value = 'true';
        });
    });

    // Initialize first button as selected
    const firstBtn = presetButtons[0] as HTMLElement;
    if (firstBtn) {
        firstBtn.classList.add('bg-neutral-200', 'dark:bg-neutral-800');
    }

    // Toggle to custom name
    toggleCustom?.addEventListener('click', () => {
        presetNamesContainer?.classList.add('hidden');
        toggleCustom.classList.add('hidden');
        customContainer?.classList.remove('hidden');
        customInput?.focus();
        isPresetInput.value = 'false';
    });

    // Back to preset names
    backToPreset?.addEventListener('click', () => {
        customContainer?.classList.add('hidden');
        presetNamesContainer?.classList.remove('hidden');
        toggleCustom?.classList.remove('hidden');
        customInput.value = '';

        // Restore preset selection
        const selected = document.querySelector('.preset-name[data-selected]') as HTMLElement;
        if (selected) {
            selectedNameInput.value = selected.dataset.name || '';
        }
        isPresetInput.value = 'true';
    });

    // Update hidden field when custom name changes
    customInput?.addEventListener('input', () => {
        selectedNameInput.value = customInput.value;
    });

    // Character count
    textarea?.addEventListener('input', () => {
        if (charCount) {
            charCount.textContent = String(textarea.value.length);
        }
    });

    // Form submission
    form?.addEventListener('submit', async (e) => {
        e.preventDefault();

        const postSlug = form.dataset.postSlug;
        const author = selectedNameInput.value.trim();
        const content = textarea.value.trim();
        const isPresetName = isPresetInput.value === 'true';

        if (!author || !content) {
            showStatus('please fill in all fields.', 'error');
            return;
        }

        submitBtn.disabled = true;
        submitBtn.textContent = 'submitting...';

        try {
            const response = await fetch('/api/comments', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    postSlug,
                    author,
                    content,
                    isPresetName
                })
            });

            const data = await response.json();

            if (response.ok) {
                showStatus('comment submitted! it will appear after moderation.', 'success');
                textarea.value = '';
                if (charCount) charCount.textContent = '0';
            } else {
                showStatus(data.error || 'failed to submit comment.', 'error');
            }
        } catch (error) {
            showStatus('failed to submit comment. please try again.', 'error');
        } finally {
            submitBtn.disabled = false;
            submitBtn.textContent = 'submit';
        }
    });

    function showStatus(message: string, type: 'success' | 'error') {
        if (formStatus && statusMessage) {
            formStatus.classList.remove('hidden');
            statusMessage.textContent = message;
            statusMessage.className = `text-sm ${type === 'success' ? 'text-green-600 dark:text-green-400' : 'text-red-600 dark:text-red-400'}`;
        }
    }
</script>
