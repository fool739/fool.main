---
const DISCORD_ID = "720005508173529169";
---

<div class="now-playing hidden items-center gap-2 text-sm text-neutral-500 dark:text-neutral-400">
    <span class="text-neutral-400 dark:text-neutral-500">Now Playing:</span>
    <a
        class="spotify-link hover:text-neutral-600 dark:hover:text-neutral-300 transition-colors truncate max-w-[200px]"
        href="#"
        target="_blank"
        rel="noopener noreferrer"
    >
        <span class="song-name"></span>
    </a>
</div>

<script define:vars={{ DISCORD_ID }}>
    async function fetchNowPlaying() {
        try {
            const response = await fetch(`https://api.lanyard.rest/v1/users/${DISCORD_ID}`);
            const data = await response.json();

            const containers = document.querySelectorAll('.now-playing');

            containers.forEach(container => {
                const songName = container.querySelector('.song-name');
                const spotifyLink = container.querySelector('.spotify-link');

                if (data.success && data.data.spotify) {
                    const spotify = data.data.spotify;
                    const trackName = `${spotify.song} - ${spotify.artist}`;

                    songName.textContent = trackName;
                    spotifyLink.href = `https://open.spotify.com/track/${spotify.track_id}`;
                    spotifyLink.title = trackName;
                    container.classList.remove('hidden');
                    container.classList.add('flex');
                } else {
                    container.classList.add('hidden');
                    container.classList.remove('flex');
                }
            });
        } catch (error) {
            console.error('Failed to fetch Lanyard data:', error);
        }
    }

    // Only run once globally
    if (!window.nowPlayingInitialized) {
        window.nowPlayingInitialized = true;
        fetchNowPlaying();
        setInterval(fetchNowPlaying, 30000);
    }
</script>
