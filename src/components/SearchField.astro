---
import "@pagefind/default-ui/css/ui.css";

interface Props {
  readonly id?: string;
  readonly className?: string;
}

const { id, className } = Astro.props as Props;
const bundlePath = new URL("pagefind/", import.meta.env.SITE || "http://localhost:4321/").pathname;

const divProps = {
  ...(id ? { id } : {}),
  ...(className ? { class: className } : {}),
};
---

<div {...divProps} data-pagefind-ui data-bundle-path={bundlePath}></div>

<script>
  import { PagefindUI } from "@pagefind/default-ui";
  
  window.addEventListener("DOMContentLoaded", () => {
    const allSelector = "[data-pagefind-ui]";
    let pagefindInstance: any = null;
    
    for (const el of document.querySelectorAll(allSelector)) {
      const elSelector = [
        ...(el.id ? [`#${el.id}`] : []),
        ...[...el.classList.values()].map((c) => `.${c}`),
        allSelector,
      ].join("");
      
      const bundlePath = el.getAttribute("data-bundle-path") || "/pagefind/";
      
      pagefindInstance = new PagefindUI({
        element: elSelector,
        bundlePath,
        showImages: false,
        debounceTimeoutMs: 100,
        showSubResults: true,
        excerptLength: 30,
        resetStyles: false
      });

      const input = el.querySelector<HTMLInputElement>(`input[type="text"]`);
      if (input) {
        input.placeholder = "Find what you're looking for.";
        input.focus();
      }

      const url = new URL(window.location.href);
      const params = new URLSearchParams(url.search);
      const query = params.get("q");
      const sort = params.get("sort");

    

      // Handle search input changes
      input?.addEventListener("input", (e) => {
        const input = e.target as HTMLInputElement;
        const url = new URL(window.location.href);
        const params = new URLSearchParams(url.search);
        
        if (input.value) {
          params.set("q", input.value);
        } else {
          params.delete("q");
        }
        
        const newUrl = params.toString() ? `${url.pathname}?${params}` : url.pathname;
        window.history.replaceState({}, "", newUrl);
        
      });
    }
  });
</script>