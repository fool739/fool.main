---
import Base from '../layouts/base.astro';
---

<Base>
    <header class="px-4">
        <h1 class="text-3xl font-bold mb-4 text-stone-900 dark:text-zinc-50">Search</h1>
        <p class="text-lg leading-relaxed mt-4 mb-8 text-neutral-600 dark:text-neutral-400">
            search through all my posts and rambling thoughts.
        </p>
    </header>

    <div class="px-4">
        <!-- Custom Search Input -->
        <div class="mb-8">
            <input 
                type="text" 
                id="search-input"
                placeholder="Search posts..."
                class="w-full p-4 text-lg border border-neutral-200 dark:border-neutral-800 rounded-lg bg-white dark:bg-neutral-900 text-stone-900 dark:text-zinc-50 placeholder-neutral-500 dark:placeholder-neutral-400 focus:outline-none focus:border-neutral-400 dark:focus:border-neutral-600 transition-colors"
            />
        </div>
        
        <!-- Search Results Container -->
        <div id="search-results" class="grid gap-6">
            <!-- Search results will be inserted here -->
        </div>

        <!-- Loading State -->
        <div id="search-loading" class="hidden text-center py-8">
            <p class="text-neutral-600 dark:text-neutral-400">Searching...</p>
        </div>

        <!-- No Results State -->
        <div id="no-results" class="hidden text-center py-8">
            <p class="text-neutral-600 dark:text-neutral-400">No results found. Try a different search term.</p>
        </div>

        <!-- Initial State -->
        <div id="search-prompt" class="text-center py-12">
            <p class="text-neutral-600 dark:text-neutral-400 text-lg">Start typing to search through posts...</p>
        </div>
    </div>

    <script is:inline>
        let pagefind = null;
        let isPagefindReady = false;

        // Initialize Pagefind
        async function initializePagefind() {
            return new Promise((resolve, reject) => {
                // Load the pagefind script
                const script = document.createElement('script');
                script.src = '/pagefind/pagefind.js';
                
                script.onload = () => {
                    // Give it a moment to attach to window
                    setTimeout(() => {
                        if (window.pagefind) {
                            pagefind = window.pagefind;
                            isPagefindReady = true;
                            console.log('Pagefind loaded successfully');
                            resolve();
                        } else {
                            console.error('Pagefind not found on window after script load');
                            reject(new Error('Pagefind not available'));
                        }
                    }, 50);
                };
                
                script.onerror = (error) => {
                    console.error('Failed to load Pagefind script:', error);
                    reject(error);
                };
                
                document.head.appendChild(script);
            });
        }

        // Show development mode message
        function showDevelopmentMessage() {
            const container = document.getElementById('search-prompt');
            if (container) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <p class="text-neutral-600 dark:text-neutral-400 text-lg mb-4">
                            Search is available after building the site.
                        </p>
                        <p class="text-sm text-neutral-500 dark:text-neutral-500">
                            Run <code class="bg-neutral-100 dark:bg-neutral-800 px-2 py-1 rounded">npm run build && npm run preview</code> to test search functionality.
                        </p>
                    </div>
                `;
            }
        }

        // Perform search
        async function performSearch(query) {
            if (!pagefind || !isPagefindReady) {
                console.warn('Pagefind not ready yet');
                return;
            }

            if (!query.trim()) {
                showElement('search-prompt');
                hideElements(['search-results', 'search-loading', 'no-results']);
                return;
            }

            showElement('search-loading');
            hideElements(['search-results', 'search-prompt', 'no-results']);

            try {
                const search = await pagefind.search(query);
                
                if (!search || !search.results || search.results.length === 0) {
                    showElement('no-results');
                    hideElements(['search-loading', 'search-results', 'search-prompt']);
                    return;
                }

                // Get detailed results
                const results = await Promise.all(
                    search.results.slice(0, 10).map((result) => result.data())
                );

                displayResults(results);
                showElement('search-results');
                hideElements(['search-loading', 'search-prompt', 'no-results']);
            } catch (error) {
                console.error('Search error:', error);
                showElement('no-results');
                hideElements(['search-loading', 'search-results', 'search-prompt']);
            }
        }

        // Display search results
        function displayResults(results) {
            const container = document.getElementById('search-results');
            if (!container) return;

            container.innerHTML = results.map(result => `
                <a href="${result.url}" class="block no-underline">
                    <article class="p-6 rounded-lg border border-neutral-200 dark:border-neutral-800 hover:border-neutral-400 dark:hover:border-neutral-600 transition-colors">
                        <h2 class="text-xl font-bold mb-2 text-stone-900 dark:text-zinc-50">
                            ${result.meta?.title || 'Untitled'}
                        </h2>
                        <p class="text-neutral-600 dark:text-neutral-400 mb-3">
                            ${result.excerpt || 'No description available.'}
                        </p>
                        <div class="text-sm text-neutral-500 dark:text-neutral-500">
                            ${result.url}
                        </div>
                    </article>
                </a>
            `).join('');
        }

        // Utility functions
        function showElement(id) {
            const element = document.getElementById(id);
            if (element) element.classList.remove('hidden');
        }

        function hideElements(ids) {
            ids.forEach(id => {
                const element = document.getElementById(id);
                if (element) element.classList.add('hidden');
            });
        }

        // Debounce function
        function debounce(func, delay) {
            let timeoutId;
            return (...args) => {
                clearTimeout(timeoutId);
                timeoutId = setTimeout(() => func.apply(null, args), delay);
            };
        }

        // Initialize when DOM is loaded
        document.addEventListener('DOMContentLoaded', async () => {
            try {
                await initializePagefind();
                
                const searchInput = document.getElementById('search-input');
                if (searchInput) {
                    const debouncedSearch = debounce(performSearch, 300);
                    
                    searchInput.addEventListener('input', (e) => {
                        const query = e.target.value;
                        if (isPagefindReady) {
                            debouncedSearch(query);
                        }
                    });

                    // Handle Enter key
                    searchInput.addEventListener('keydown', (e) => {
                        if (e.key === 'Enter') {
                            e.preventDefault();
                            const query = e.target.value;
                            if (isPagefindReady) {
                                performSearch(query);
                            }
                        }
                    });
                }
            } catch (error) {
                console.error('Failed to initialize Pagefind:', error);
                showDevelopmentMessage();
            }
        });
    </script>

    <style>
        /* Additional styles for search states */
        #search-input:focus {
            box-shadow: 0 0 0 3px rgba(0, 0, 0, 0.1);
        }

        .dark #search-input:focus {
            box-shadow: 0 0 0 3px rgba(255, 255, 255, 0.1);
        }

        /* Loading animation */
        #search-loading::after {
            content: '';
            display: inline-block;
            width: 20px;
            height: 20px;
            border: 2px solid #ccc;
            border-radius: 50%;
            border-top-color: #333;
            animation: spin 1s ease-in-out infinite;
            margin-left: 10px;
        }

        .dark #search-loading::after {
            border-color: #555;
            border-top-color: #ccc;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        code {
            font-family: 'Courier New', monospace;
        }
    </style>
</Base>